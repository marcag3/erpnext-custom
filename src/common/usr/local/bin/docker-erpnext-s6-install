#!/bin/sh
# ERPNext S6 Overlay Installation Script
# Based on serversideup pattern

set -e

S6_VERSION=v3.2.1.0
S6_DIR=${S6_DIR:-/opt/s6/}
S6_SRC_URL=${S6_SRC_URL:-"https://github.com/just-containers/s6-overlay/releases/download"}

# Create S6 directory
mkdir -p $S6_DIR

# Detect architecture
export SYS_ARCH=$(uname -m)
case "$SYS_ARCH" in
    aarch64 ) export S6_ARCH='aarch64' ;;
    arm64   ) export S6_ARCH='aarch64' ;;
    armhf   ) export S6_ARCH='armhf'   ;;
    arm*    ) export S6_ARCH='arm'     ;;
    i4*     ) export S6_ARCH='i486'    ;;
    i6*     ) export S6_ARCH='i686'    ;;
    s390*   ) export S6_ARCH='s390x'   ;;
    *       ) export S6_ARCH='x86_64'  ;;
esac

# Function to download and extract
untar() {
    echo "⏬ Downloading $1"
    curl -L $1 -o - | tar Jxp -C $S6_DIR
}

echo "⬇️ Downloading s6 overlay:${S6_ARCH}-${S6_VERSION} for ${SYS_ARCH}"
untar ${S6_SRC_URL}/${S6_VERSION}/s6-overlay-noarch.tar.xz
untar ${S6_SRC_URL}/${S6_VERSION}/s6-overlay-${S6_ARCH}.tar.xz

echo "S6 Overlay installation completed"
