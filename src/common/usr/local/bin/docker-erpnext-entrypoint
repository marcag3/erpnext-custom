#!/bin/sh
# ERPNext Docker Entrypoint Script
# Based on serversideup pattern with linuxserver.io user switching
# Orchestrates entrypoint scripts and user switching

set -e

# Source environment variables
if [ -f /etc/environment ]; then
    . /etc/environment
fi

# Check if we're running as root
if [ "$(id -u)" = "0" ]; then
    echo "Running as root, fixing permissions..."
    
    # Run unified permission management script
    docker-erpnext-permissions
    
    # Run entrypoint scripts as frappe user (without exec, so we stay as root)
    if [ -d /etc/entrypoint.d ]; then
        for script in /etc/entrypoint.d/[0-9]*-*.sh; do
            if [ -f "$script" ] && [ -x "$script" ]; then
                echo "Running entrypoint script as frappe: $script"
                su frappe -s /bin/sh -c ". \"$script\""
            fi
        done
    fi
    
    # Execute the main command as root (S6 /init must run as PID 1)
    # S6 overlay will handle user switching for individual services
    exec "$@"
fi

# If we somehow get here as non-root, just execute the command
exec "$@"
